/**
 * Auth Routes Tests
 * ทดสอบการทำงานของ Authentication routes
 * 
 * หมายเหตุ: Tests เหล่านี้ใช้ mocked database และ accountLockout
 * สำหรับการทดสอบแบบเต็มรูปแบบ ควรใช้ test database จริง
 * 
 * ไฟล์นี้ถูก skip จาก frontend test runner (ใช้ .skip extension)
 * ให้รันด้วย npm run test:backend แทน
 */

import { describe, it, expect, vi, beforeEach } from 'vitest'
import request from 'supertest'
import express from 'express'

// Mock database pool ก่อน import routes
const mockExecute = vi.fn().mockResolvedValue([[], []])

vi.mock('../config/database.js', () => {
  return {
    default: {
      execute: mockExecute,
      getConnection: vi.fn().mockResolvedValue({
        execute: mockExecute,
        release: vi.fn(),
      }),
    },
  }
})

// Mock accountLockout functions ก่อน import routes
vi.mock('../utils/accountLockout.js', () => {
  return {
    checkAccountLockout: vi.fn().mockResolvedValue({ locked: false }),
    recordLoginAttempt: vi.fn().mockResolvedValue(undefined),
    clearFailedAttempts: vi.fn().mockResolvedValue(undefined),
    getClientIp: vi.fn(() => '127.0.0.1'),
  }
})

// Import routes หลังจาก mock
import authRoutes from '../auth.js'

const app = express()
app.use(express.json())
app.use('/api/auth', authRoutes)

describe('POST /api/auth/login', () => {
  beforeEach(() => {
    vi.clearAllMocks()
  })

  it('should return 400 if username is missing', async () => {
    const response = await request(app)
      .post('/api/auth/login')
      .send({ password: 'password123' })

    expect(response.status).toBe(400)
    expect(response.body).toHaveProperty('success', false)
    expect(response.body).toHaveProperty('message')
  })

  it('should return 400 if password is missing', async () => {
    const response = await request(app)
      .post('/api/auth/login')
      .send({ username: 'test@example.com' })

    expect(response.status).toBe(400)
    expect(response.body).toHaveProperty('success', false)
    expect(response.body).toHaveProperty('message')
  })

  it('should return 400 for invalid username format', async () => {
    const response = await request(app)
      .post('/api/auth/login')
      .send({
        username: 'invalid',
        password: 'password123',
      })

    expect(response.status).toBe(400)
    expect(response.body).toHaveProperty('success', false)
    expect(response.body).toHaveProperty('message')
  })
})

describe('POST /api/auth/logout', () => {
  it('should return 401 if no token provided', async () => {
    const response = await request(app).post('/api/auth/logout')

    expect(response.status).toBe(401)
  })
})
